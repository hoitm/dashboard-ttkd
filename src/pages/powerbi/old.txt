

// File: src/pages/PowerBIReport.jsx
import React, { useEffect, useState, useRef } from 'react';
import { PowerBIEmbed } from 'powerbi-client-react';
import { models } from 'powerbi-client';
import axios from 'axios';
import './powerbiNew.css';

import {
  BarChart,
  ChevronLeft,
  ChevronRight
} from '@mui/icons-material';

const PowerBIReport = ({ reportId, groupId }) => {
  const [reportConfig, setReportConfig] = useState(null);
  const [pages, setPages] = useState([]);
  const [activePage, setActivePage] = useState('');
  const [error, setError] = useState(null);
  const [isLoadingPages, setIsLoadingPages] = useState(true);
  const reportRef = useRef(null);
  const accessTokenRef = useRef('');
  const [isSidebarVisible, setIsSidebarVisible] = useState(true);
  const [isMobile, setIsMobile] = useState(window.innerWidth < 768);


// üÜï T·ª± ch·ªçn reportId theo thi·∫øt b·ªã
const reportId = isMobile
? 'b8e41ae1-e64c-4089-9272-9ef9755a68f8' // Mobie
: '832e4653-ea41-4eb0-967c-e87539de2c7f'; // Desktop

  const fetchToken = async () => {
    const tokenResponse = await axios.get('https://ttkdapi.vnptphuyen.vn/api/AzureAdToken/getToken');
    const accessToken = tokenResponse.data.accessToken;
    accessTokenRef.current = accessToken;
    return accessToken;
  };

  const generateEmbedToken = async (accessToken) => {
    const embedTokenResponse = await axios.post(
      `https://api.powerbi.com/v1.0/myorg/groups/${groupId}/reports/${reportId}/GenerateToken`,
      { accessLevel: 'View' },
      {
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        }
      }
    );
    return embedTokenResponse.data.token;
  };

  const refreshReportConfig = async () => {
    try {
      const accessToken = await fetchToken();
      const embedToken = await generateEmbedToken(accessToken);

      setReportConfig(prevConfig => ({
        ...prevConfig,
        accessToken: embedToken,
      }));

      return embedToken;
    } catch (error) {
      console.error('Error refreshing report config:', error);
      setError('Failed to refresh report. Please try again later.');
      throw error;
    }
  };
  useEffect(() => {
    const handleResize = () => {
      setIsMobile(window.innerWidth < 768);
    };
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);
  useEffect(() => {
    const fetchReportDetails = async () => {
      try {
        const accessToken = await fetchToken();

        const embedUrlResponse = await axios.get(
          `https://api.powerbi.com/v1.0/myorg/groups/${groupId}/reports/${reportId}`,
          {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          }
        );
        const embedUrl = embedUrlResponse.data.embedUrl;
        const embedToken = await generateEmbedToken(accessToken);

        setReportConfig({
          type: 'report',
          id: reportId,
          embedUrl: embedUrl,
          accessToken: embedToken,
          tokenType: models.TokenType.Embed,
          settings: {
            panes: {
              pageNavigation: {
                visible: false
              }
            },
            background: models.BackgroundType.Transparent,
          }
        });

        pollForPages();
      } catch (error) {
        console.error('Error fetching report details:', error);
        setError('Failed to load report. Please try again later.');
        setIsLoadingPages(false);
      }
    };

    fetchReportDetails();
  }, [reportId, groupId]);
  useEffect(() => {
    const handleResize = () => {
      if (window.innerWidth < 768) {
        setIsSidebarVisible(false);
      }
    };
    window.addEventListener('resize', handleResize);
    handleResize();
    return () => window.removeEventListener('resize', handleResize);
  }, []);


  
  const pollForPages = async (attempts = 0) => {
    if (attempts > 10) {
      setIsLoadingPages(false);
      return;
    }

    try {
      const pagesResponse = await axios.get(
        `https://api.powerbi.com/v1.0/myorg/groups/${groupId}/reports/${reportId}/pages`,
        {
          headers: {
            'Authorization': `Bearer ${accessTokenRef.current}`
          }
        }
      );
      const fetchedPages = pagesResponse.data.value;

      if (fetchedPages && fetchedPages.length > 0) {
        setPages(fetchedPages);
        setActivePage(fetchedPages[0].name);
        setIsLoadingPages(false);
      } else {
        setTimeout(() => pollForPages(attempts + 1), 2000);
      }
    } catch (error) {
      console.error('Error fetching pages:', error);
      setTimeout(() => pollForPages(attempts + 1), 2000);
    }
  };

  const handleReportLoad = (report) => {
    reportRef.current = report;
  };

  const handlePageChange = async (pageName) => {
    try {
     // await refreshReportConfig();
      if (reportRef.current) {
        await reportRef.current.setPage(pageName);
        setActivePage(pageName);
      }
    } catch (error) {
      console.error('Error changing page:', error);
      setError('Failed to change page. Please try again.');
    }
  };

  if (error) {
    return <div className="text-red-500 p-4">{error}</div>;
  }

  if (!reportConfig) {
    return (
      <div className="flex justify-center items-center h-screen">
        <div className="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500"></div>
      </div>
    );
  }

  return (
    <div className="flex h-screen bg-gray-100">
      <div className={`transition-all duration-300 bg-white shadow-md h-full overflow-auto ${isSidebarVisible ? 'w-64' : 'w-12'} min-w-[3rem] max-w-[400px] relative`}>
        <button
          onClick={() => setIsSidebarVisible(!isSidebarVisible)}
          className="absolute -right-0 top-4 z-10 bg-blue-500 text-white p-1 rounded-full shadow-md hover:bg-blue-600 transition"
          title={isSidebarVisible ? '·∫®n menu' : 'Hi·ªán menu'}
        >
          {isSidebarVisible ? <ChevronLeft style={{ fontSize: 30 }} /> : <ChevronRight style={{ fontSize: 30 }} />}
        </button>

        {/*
           <div className="p-4">
          {isSidebarVisible && (
            <>
              <h2 className="text-lg font-semibold mb-4 text-gray-700">Trang b√°o c√°o</h2>
              {isLoadingPages ? (
                <p>ƒêang t·∫£i trang...</p>
              ) : pages.length === 0 ? (
                <p>Kh√¥ng c√≥ trang n√†o. H√£y th·ª≠ t·∫£i l·∫°i.</p>
              ) : (
                pages.map((page) => (
                  <button
                    key={page.name}
                    onClick={() => handlePageChange(page.name)}
                    title={page.displayName}
                    className={`w-full text-left py-2 px-4 mb-2 rounded-lg flex items-center gap-2 transition-all duration-150 ease-in-out ${activePage === page.name ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 hover:bg-blue-100 text-gray-800'}`}
                  >
                    <BarChart style={{ fontSize: 16, color: '#' + Math.floor(Math.random()*16777215).toString(16) }} />
                    <span className="truncate">{page.displayName}</span>
                  </button>
                ))
              )}
            </>
          )}
        </div>
        */}

        <div className="p-4">
  {isSidebarVisible && (
    <>
      <h2 className="text-lg font-semibold mb-4 text-gray-700">Trang b√°o c√°o</h2>
      {isLoadingPages ? (
        <p>ƒêang t·∫£i trang...</p>
      ) : pages.length === 0 ? (
        <p>Kh√¥ng c√≥ trang n√†o. H√£y th·ª≠ t·∫£i l·∫°i.</p>
      ) : (
        // üî• L·ªçc danh s√°ch trang theo thi·∫øt b·ªã
        pages
          .filter(page =>
            isMobile
              ? page.displayName.toLowerCase().includes('mobie')
              : !page.displayName.toLowerCase().includes('mobie')
          )
          .map((page) => (
            <button
              key={page.name}
              onClick={() => handlePageChange(page.name)}
              title={page.displayName}
              className={`w-full text-left py-2 px-4 mb-2 rounded-lg flex items-center gap-2 transition-all duration-150 ease-in-out ${
                activePage === page.name
                  ? 'bg-blue-600 text-white shadow-md'
                  : 'bg-gray-100 hover:bg-blue-100 text-gray-800'
              }`}
            >
              <BarChart
                style={{
                  fontSize: 16,
                  color: '#' + Math.floor(Math.random() * 16777215).toString(16),
                }}
              />
              <span className="truncate">{page.displayName}</span>
            </button>
          ))
      )}
    </>
  )}
</div>

      </div>



      <div className="flex-1 flex flex-col p-4 h-[calc(100vh-2rem)] max-h-screen overflow-hidden">
  <div className="bg-white shadow-lg rounded-lg overflow-hidden h-full">
    <div className="powerbi-container">
    {isMobile ? (
        <PowerBIEmbed
          embedConfig={{
            ...reportConfig,
            settings: {
              ...reportConfig.settings,
             layoutType: isMobile
              ? models.LayoutType.Custom // ho·∫∑c .Master c≈©ng ƒë∆∞·ª£c
              : models.LayoutType.Custom,
              panes: {
                pageNavigation: { visible: false },
              },
              background: models.BackgroundType.Transparent,
            },
          }}
          cssClassName="h-full w-full"
          eventHandlers={new Map([
            ['loaded', () => {
              console.log('‚úÖ Report loaded');
              if (reportRef.current) {
                reportRef.current.getPages().then(pages => {
                  const mobilePage = pages.find(p =>
                    p.displayName.toLowerCase().includes('mobie') ||
                    p.name.toLowerCase().includes('mobie')
                  );
                  if (mobilePage) {
                    console.log('üëâ Switching to Mobie page:', mobilePage.displayName);
                    reportRef.current.setPage(mobilePage.name);
                    setActivePage(mobilePage.name);
                  } else {
                    console.warn('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y trang Mobie.');
                  }
                });
              }
            }],
            ['rendered', () => console.log('‚úÖ Report rendered')],
            ['error', async (event) => {
              console.error('‚ùå Embedding error:', event.detail);
              try {
                await refreshReportConfig();
                console.log('üîÅ Token refreshed');
              } catch (refreshError) {
                setError('Error embedding report. Please try again later.');
              }
            }],
            ['pageChanged', (event) => {
              if (event.detail.newPage) {
                setActivePage(event.detail.newPage.name);
              }
            }],
          ])}
          getEmbeddedComponent={(report) => {
            reportRef.current = report;
          }}
        />
      ) : (
        <div className="powerbi-container">
          <PowerBIEmbed
              embedConfig={{
        ...reportConfig,
        settings: {
          ...reportConfig.settings,
          layoutType: isMobile 
            ? models.LayoutType.MobilePortrait
            : models.LayoutType.Custom,
        },
      }}
      eventHandlers={new Map([
            ['loaded', () => {
              console.log('‚úÖ Report loaded');
              if (reportRef.current) {
                reportRef.current.getPages().then(pages => {
                  const mobilePage = pages.find(p =>
                    p.displayName.toLowerCase().includes('mobie') ||
                    p.name.toLowerCase().includes('mobie')
                  );
                  if (mobilePage) {
                    console.log('üëâ Switching to Mobie page:', mobilePage.displayName);
                    reportRef.current.setPage(mobilePage.name);
                    setActivePage(mobilePage.name);
                  } else {
                    console.warn('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y trang Mobie.');
                  }
                });
              }
            }],
            ['rendered', () => console.log('‚úÖ Report rendered')],
            ['error', async (event) => {
              console.error('‚ùå Embedding error:', event.detail);
              try {
                await refreshReportConfig();
                console.log('üîÅ Token refreshed');
              } catch (refreshError) {
                setError('Error embedding report. Please try again later.');
              }
            }],
            ['pageChanged', (event) => {
              if (event.detail.newPage) {
                setActivePage(event.detail.newPage.name);
              }
            }],
          ])}
            
            cssClassName="h-full w-full"
            getEmbeddedComponent={(embeddedReport) => {
              handleReportLoad(embeddedReport);
            }}
           
          />  </div>
      )}
    {/*<PowerBIEmbed
  embedConfig={{
    ...reportConfig,
    settings: {
      ...reportConfig.settings,
      layoutType: models.LayoutType.Custom,
      panes: {
        pageNavigation: { visible: false },
      },
      background: models.BackgroundType.Transparent,
    },
  }}
  cssClassName="h-full w-full"
  eventHandlers={new Map([
    ['loaded', () => {
      console.log('‚úÖ Report loaded');
      if (reportRef.current && isMobile) {
        reportRef.current.getPages().then(pages => {
          const mobilePage = pages.find(p =>
            p.displayName.toLowerCase().includes('mobie') ||
            p.name.toLowerCase().includes('mobie')
          );
          if (mobilePage) {
            console.log('üëâ Switching to Mobie page:', mobilePage.displayName);
            reportRef.current.setPage(mobilePage.name);
            setActivePage(mobilePage.name);
          } else {
            console.warn('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y trang Mobie.');
          }
        });
      }
    }],
    ['rendered', () => console.log('‚úÖ Report rendered')],
    ['error', async (event) => {
      console.error('‚ùå Embedding error:', event.detail);
      try {
        await refreshReportConfig();
        console.log('üîÅ Token refreshed');
      } catch (refreshError) {
        setError('Error embedding report. Please try again later.');
      }
    }],
    ['pageChanged', (event) => {
      if (event.detail.newPage) {
        setActivePage(event.detail.newPage.name);
      }
    }],
  ])}
  getEmbeddedComponent={(report) => {
    reportRef.current = report;
  }}
/>

     */}

    </div>
  </div>
</div>

      
    </div>
  );
};

export default PowerBIReport;

/*
  {isMobile ? (
        <PowerBIEmbed
          embedConfig={{
            ...reportConfig,
            settings: {
              ...reportConfig.settings,
              layoutType: models.LayoutType.Custom, // KH√îNG d√πng MobilePortrait v√¨ kh√¥ng c√≥ hi·ªáu l·ª±c khi embed
              panes: {
                pageNavigation: { visible: false },
              },
              background: models.BackgroundType.Transparent,
            },
          }}
          cssClassName="h-full w-full"
          eventHandlers={new Map([
            ['loaded', () => {
              console.log('‚úÖ Report loaded');
              if (reportRef.current) {
                reportRef.current.getPages().then(pages => {
                  const mobilePage = pages.find(p =>
                    p.displayName.toLowerCase().includes('mobie') ||
                    p.name.toLowerCase().includes('mobie')
                  );
                  if (mobilePage) {
                    console.log('üëâ Switching to Mobie page:', mobilePage.displayName);
                    reportRef.current.setPage(mobilePage.name);
                    setActivePage(mobilePage.name);
                  } else {
                    console.warn('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y trang Mobie.');
                  }
                });
              }
            }],
            ['rendered', () => console.log('‚úÖ Report rendered')],
            ['error', async (event) => {
              console.error('‚ùå Embedding error:', event.detail);
              try {
                await refreshReportConfig();
                console.log('üîÅ Token refreshed');
              } catch (refreshError) {
                setError('Error embedding report. Please try again later.');
              }
            }],
            ['pageChanged', (event) => {
              if (event.detail.newPage) {
                setActivePage(event.detail.newPage.name);
              }
            }],
          ])}
          getEmbeddedComponent={(report) => {
            reportRef.current = report;
          }}
        />
      ) : (
        <div className="powerbi-container">
          <PowerBIEmbed
              embedConfig={{
        ...reportConfig,
        settings: {
          ...reportConfig.settings,
          layoutType: isMobile 
            ? models.LayoutType.MobilePortrait
            : models.LayoutType.Custom,
        },
      }}
      eventHandlers={new Map([
            ['loaded', () => {
              console.log('‚úÖ Report loaded');
              if (reportRef.current) {
                reportRef.current.getPages().then(pages => {
                  const mobilePage = pages.find(p =>
                    p.displayName.toLowerCase().includes('mobie') ||
                    p.name.toLowerCase().includes('mobie')
                  );
                  if (mobilePage) {
                    console.log('üëâ Switching to Mobie page:', mobilePage.displayName);
                    reportRef.current.setPage(mobilePage.name);
                    setActivePage(mobilePage.name);
                  } else {
                    console.warn('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y trang Mobie.');
                  }
                });
              }
            }],
            ['rendered', () => console.log('‚úÖ Report rendered')],
            ['error', async (event) => {
              console.error('‚ùå Embedding error:', event.detail);
              try {
                await refreshReportConfig();
                console.log('üîÅ Token refreshed');
              } catch (refreshError) {
                setError('Error embedding report. Please try again later.');
              }
            }],
            ['pageChanged', (event) => {
              if (event.detail.newPage) {
                setActivePage(event.detail.newPage.name);
              }
            }],
          ])}
            
            cssClassName="h-full w-full"
            getEmbeddedComponent={(embeddedReport) => {
              handleReportLoad(embeddedReport);
            }}
           
          />  </div>
      )}
*/

 